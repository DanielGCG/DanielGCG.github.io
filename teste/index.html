<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Arquivos</title>
</head>
<body>
    <h1>Upload de Arquivos</h1>

    <!-- Formulário de Login -->
    <form id="loginForm">
        <input type="email" id="emailInput" placeholder="Email" required>
        <input type="password" id="passwordInput" placeholder="Senha" required>
        <button type="submit">Fazer Login</button>
    </form>

    <!-- Formulário de Cadastro -->
    <form id="registerForm" style="display: none;">
        <input type="email" id="registerEmailInput" placeholder="Email" required>
        <input type="password" id="registerPasswordInput" placeholder="Senha" required>
        <button type="submit">Criar Conta</button>
    </form>

    <!-- Formulário de Upload -->
    <form id="uploadForm" style="display: none;">
        <input type="file" id="fileInput" />
        <button type="submit">Upload</button>
    </form>

    <!-- Seção para mostrar arquivos -->
    <div id="filesSection" style="display: none;">
        <h2>Arquivos</h2>
        <ul id="filesList"></ul>
    </div>

    <!-- Botões de Login/Logout -->
    <button id="loginBtn" style="display: none;">Fazer Login</button>
    <button id="logoutBtn" style="display: none;">Sair</button>

    <!-- Botão para mostrar o formulário de cadastro -->
    <button id="showRegisterFormBtn">Criar Conta</button>

    <!-- Adicione os scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js"></script>

    <script>
        // Configurações do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyASiPD0smWeqgsB7wm2oj_sv3rp4i2LkKo",
            authDomain: "siteboteco.firebaseapp.com",
            projectId: "siteboteco",
            storageBucket: "siteboteco.appspot.com",
            messagingSenderId: "618682213921",
            appId: "1:618682213921:web:1cb5247779a050ff20a560"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Gerenciar o estado de login
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("Usuário logado:", user);
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('uploadForm').style.display = 'block';
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'block';
                    document.getElementById('filesSection').style.display = 'block';
                    listFiles(); // Lista os arquivos após o login
                })
                .catch((error) => {
                    console.error("Erro de login:", error);
                    alert("Erro de login. Verifique suas credenciais.");
                });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    console.log("Usuário deslogado");
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('uploadForm').style.display = 'none';
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'none';
                    document.getElementById('filesSection').style.display = 'none';
                })
                .catch((error) => {
                    console.error("Erro no logout:", error);
                });
        });

        // Criar um novo usuário
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmailInput').value;
            const password = document.getElementById('registerPasswordInput').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("Usuário criado:", user);
                    // Redirecione para a página de login ou exiba uma mensagem de sucesso
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('registerForm').style.display = 'none';
                    alert("Conta criada com sucesso. Faça login para continuar.");
                })
                .catch((error) => {
                    console.error("Erro no cadastro:", error);
                    // Exiba uma mensagem de erro para o usuário
                    alert("Erro ao criar conta. Verifique os dados inseridos.");
                });
        });

        // Mostrar/Ocultar Formulários
        document.getElementById('showRegisterFormBtn').addEventListener('click', () => {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        });

        // Função de upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Verifique se o usuário está autenticado
            if (!auth.currentUser) {
                alert('Você precisa fazer login para fazer upload de arquivos.');
                return;
            }

            const file = document.getElementById('fileInput').files[0];
            const storageRef = storage.ref().child('uploads/' + file.name);

            try {
                // Monitora o progresso do upload
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                  (snapshot) => {
                    // Progresso do upload
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                  },
                  (error) => {
                    // Erro no upload
                    console.error('Error uploading file:', error);
                  },
                  () => {
                    // Upload concluído
                    alert('File uploaded successfully!');
                    listFiles(); // Atualiza a lista de arquivos
                  }
                );

            } catch (error) {
                console.error('Error uploading file:', error);
            }
        });

        // Lista os arquivos no Firebase Storage
        function listFiles() {
            const listRef = storage.ref().child('uploads');

            listRef.listAll()
                .then((res) => {
                    const filesList = document.getElementById('filesList');
                    filesList.innerHTML = ''; // Limpa a lista anterior

                    res.items.forEach((itemRef) => {
                        itemRef.getDownloadURL()
                            .then((url) => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <a href="${url}" download="${itemRef.name}">${itemRef.name}</a>
                                `;
                                filesList.appendChild(li);
                            })
                            .catch((error) => {
                                console.error("Erro ao obter URL de download:", error);
                            });
                    });
                })
                .catch((error) => {
                    console.error("Erro ao listar arquivos:", error);
                });
        }
    </script>
</body>
</html>